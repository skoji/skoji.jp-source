---
layout: post
title: Mastodon個人的ふりかえり
date: '2017-12-05T00:00:00+09:00'
image: /blog/images/elephant-fren.png
categories:
- Mastodon
---

これは[Mastodon Advent Calendar](https://adventar.org/calendars/2178) 5日目の記事です。

私は今年の4月頃にMastodonのいくつかのインスタンスにユーザ登録して、5月はじめに[シングルユーザのインスタンス](https://sandbox.skoji.jp)を、7月に公開インスタンス[bookwor.ms](https://bookwor.ms)を立ち上げました。

以下、この半年ちょっとのMastodonについての経験を振り返って、技術的なこととか技術的ではないことをとりとめなく書いていきます。

## 4月: いろんなInstanceに参加

[本家](https://mastodon.social)、[jp](https://mstdn.jp)、[fm](https://mstdn.fm)など複数のインスタンスにアカウントを作って試し始めました。Twitterなどでの知り合いは少なく、すぐに飽きるかな、と思っていたら意外にもさまざまな方とやりとりしていただけるようになりました。当初はMastodonそのものについて語っていることがほとんどだった気がします。

## 5月: シングルユーザインスタンス

手元で動かしてみたくなって、シングルユーザのインスタンス（いわゆる「おひとりさまインスタンス」）を[5月にたてました](/blog/2017/05/mastodon.html)。このブログをホストしているサーバにDockerを使ってドキュメント通りに設置しています。もともとLet's Encryptでhttps化はしていたので、サブドメインの証明書を追加するなどは楽にできました。

## 5月: 最初のトラブル

v1.4rc3へのバージョンアップ時に、`rails assets:precompile` が失敗する問題が出てきました。当初は[yarnのバージョンをさげる](/blog/2017/05/mastodon-14update.html)ことで対処していたけれども、途中からMac上にrsyncして、Mac上で`assets:precompile`して、rsyncで書き戻すように変更してしのぎました。この問題は[v1.4.4以降は起きなくなった](https://github.com/tootsuite/mastodon/issues/3251#issuecomment-309960377)（yarnが呼び出されなくなった）ので現在は平和です。

## 6月: ディスクが圧迫されてくる

ローカルユーザひとりでもだんだんディスクが圧迫されてくることに気づきました。第一の理由はメディアファイル。Mastodonにはリモートインスタンスからのtootの添付メディアを削除するrailsタスク`mastodon:media:remove_remote`があるので、それを時々呼ぶようにしました。それでリモートtootのメディアが消えちゃうと見づらくなるなあ、と思っていましたが、今は再アクセスすると[再ダウンロードするようになっている](https://github.com/tootsuite/mastodon/pull/4955)ので安心してじゃんじゃん削除できます。

第二の理由はdocker。徐々に`/var/lib/docker`配下が大きくなる現象が起きるのです。`docker system prune -a`してもimageのビルドなどを繰り返すと単調増加します。これまでに2回、`/var/lib/docker`以下を削除してイメージの再構築をしています。

## 7月: 公開インスタンス

おひとりさまインスタンスで2ヶ月ほどあそんでいたらむずむずしてきて、公開インスタンスをたてたくなりました。

インスタンスのテーマはとても迷いました。テーマはあったほうがよいけれど、話題があまりにしぼられると私自身が使わなくなるな、と思っていたからです。フィクション全般を愛するひと、でどうかな…とおもいつつドメインを探していたら、[bookwor.ms](https://bookwor.ms)というドメインがあいていることに気づき、テーマは「本」に決定したのでした。

ここまで2ヶ月でのディスク不足の経験から

* Dockerは使わない
* メディアファイルはオブジェクトストレージに置く

という方針をたてて、[順調に設置](/blog/2017/07/bookworms.html)しました。
## 7月: ストレージのトラブル

しかし、7月後半に、メディアファイル置き場に使っていたさくらのオブジェクトストレージでトラブルが頻発。設置から半月後にはメディアファイルは[S3に引っ越しました](/blog/2017/08/mastodon-s3-setup.html)。

さくらのクラウドは良いサービスで基本的には安定しているのですが、オブジェクトストレージだけはどうもダメです。9月に再度大きなトラブルが発生した後は、この記事を書いている12月5日もまだ新規バケット作成受付を停止しています。

## 8月以降: 順調にユーザ増える

ストレージのトラブル解消後、試験運用という体だった[bookwor.ms](https://bookwor.ms)を本格運用と宣言しました。このあたりにはもう、私にとっては他のSNSと同様に、落ち着いて日常的に読んだり書いたりする場になってきていました。

その後[順調にユーザは増えて](https://bookwor.ms/@skoji/39963)、現時点は84ユーザです。話がそれますが、このtootで言及している[Mastodon Network Monitoring Project](https://dashboards.mnm.social/)は、世界中のMastodonインスタンスにかんする統計データをさまざまな側面から観測できる楽しくて素晴らしいサイトです。


## 10月: アップデートでトラブル

rcが出てきたらすぐにシングルユーザインスタンスをアップデートし、[bookwor.ms](https://bookwor.ms)は正式版リリースの翌日くらいにアップデートするようにしています。アップデートでなにかはまるところがあれば、先に洗い出せるかもしれないからです。v2.0.0では非互換な変更がいくつかはいっていて、先にスマートフォンアプリの対応状況をrc版で確認したりもしていました。

が、v2.0.0については、[bookwor.ms](https://bookwor.ms)のほうだけでトラブルが起きました。[`db:migrate`がうまく動作しなかった](https://github.com/tootsuite/mastodon/issues/5483)のです。さいわい、一時間程度でワークアラウンドを発見できましたが、住人の方々に迷惑をかけてしまいました。

しかし1.4rcとこの2.0.0をのぞけばアップデートでトラブルが起こったことはありません。

## まとめ

こう振り返ると、運用者としても楽しく設置し運用し、Mastodonのユーザとしても楽しんだ半年でした。

[bookwor.ms](https://bookwor.ms)は参加者の皆様のおかげで、のんびりゆっくりした心地よい場所になっています。時々本についての濃いめの話題が投下されて、買う本が増えることもあります。

Mastodonのコードは現在もばんばん進化しています。次のバージョン2.1では、別インスタンスへの引っ越しをサポートする機能がついに提供されます。私自身は自分が管理しているインスタンスがあるのでこの機能を使う予定はないですが、これでMastodon界隈がもっと活性化するきっかけになるかも、って期待しています。当初は私もコード少しはさわろうとおもっていたのですが、変化が高速すぎてまったくついていけていません。でもちょっとSidekiqまわり読んでみようと今もくろんでいます。

日本には[Pawoo](https://pawoo.net)、[mstdn.jp](https://mstdn.jp)、[friends.nico](https://friends.nico)の3大インスタンスをはじめとした大きなインスタンスがいくつもある一方で、わが[bookwor.ms](https://bookwor.ms)のような小さいけれどもそれぞれのやりかたでにぎわっているインスタンスも多数あります。これは海外でも同じです。

多様性をもちつつもゆるくつながるMastodon、コードとコミュニティが来年以降も健全に育っていくことを期待し楽しみにしています。わたしもできる範囲でほんの少しでも貢献する心づもりです。

