---
layout: post
title: WASMがスタックマシンでありWATがS式であり
date: '2025-07-05T15:44:22+09:00'
categories:
 - プログラミング言語
 - WASM
---

WASMのテキスト表現（つまりアセンブリ言語的なやつ）WATについて、[MDNのイントロダクション的なドキュメント](https://developer.mozilla.org/ja/docs/WebAssembly/Guides/Understanding_the_text_format)を読んでいる。WASMはスタックマシンなのにWATはS式表現だ。そして、この両方の記述ができる。

```
(module
  (func $add (param $lhs i32) (param $rhs i32) (result i32)
    local.get $lhs
    local.get $rhs
    i32.add)
  (export "add" (func $add))
)
```

上記はMDNにも出ている例。単純にふたつの数を足す関数を持つモジュールだ。このモジュールは、こうもかける。

```
 (module
  (func $add (param $lhs i32) (param $rhs i32) (result i32)
    (i32.add (local.get $lhs) (local.get $rhs)))
  (export "add" (func $add))
)
```

前者で関数`$add`のbodyは、

```
local get $lhs
local get $rhs
i32.add
```

と書かれている。これは、`$lhs`とラベルが付けられた引数をスタックにつみ、`$rhs`を同じくスタックにつみ、`i32.add`という組み込みの（という表現が適切なのかわかっていないが）関数を呼び出す、という意味だ。スタックに積まれたふたつの引数は消費され、加算された結果が残る。

後者では、関数のbodyはこう書かれている。

```
(i32.add (local.get $lhs) (local.get $rhs))
```

ぱっと見で意味は読み取れるが、スタックマシンの痕跡は消えている。そして、これは上記と完全に等価のようだ（wasmに変換した結果の差もないし、wasm2watの結果も差がない）。つまり、「引数をスタックに積んでから関数を呼ぶ」という処理を、見た目はLispぽい後置記法で書ける、ということなんだろう。

これはWATの仕様なんだろうけど、手で書くことはおそらく想定していない記法でこの「便利」さ必要だったのかなあ、と疑問に思う。まだWASMのことをほとんど何も知らないので、見当違いな疑問なのかもしれない。
